<!DOCTYPE html>
<html>

<head>
    <title>Prrueba concepto para MSAL JS</title>

    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.js">
    </script>
    <style>
        /* DivTable.com */
        
        .divTable {
            display: table;
            width: 100%;
        }
        
        .divTableRow {
            display: table-row;
        }
        
        .divTableHeading {
            background-color: #EEE;
            display: table-header-group;
        }
        
        .divTableCell,
        .divTableHead {
            border: 1px solid #999999;
            display: table-cell;
            padding: 3px 10px;
        }
        
        .divTableHeading {
            background-color: #EEE;
            display: table-header-group;
            font-weight: bold;
        }
        
        .divTableFoot {
            background-color: #EEE;
            display: table-footer-group;
            font-weight: bold;
        }
        
        .divTableBody {
            display: table-row-group;
        }
        
        .ventanaIframe {
            border: 5px solid rgb(34, 72, 207);
            width: 800px;
            height: 720px;
        }
    </style>
</head>

<body>
    <h2>Prueba concepto app to sharepoint online con MSAL.js </h2><br />
    <h4 id="WelcomeMessage"></h4>
    <button id="SignIn" onclick="signIn()">Sign In</button><br /><br />
    <pre id="json"></pre>
    <button id="LLamaSharepoint" onclick="DameFicherosSharepoint()">Dame Todos Los Ficheros</button><br /><br />
    <pre id="misFicheros"></pre>

    <script>
        var msalConfig = {
            auth: {
                clientId: "d290532f-13c6-46eb-91e8-dea61d1c6476",
                authority: "https://login.microsoftonline.com/organizations"
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            }
        };

        var sharePointConfig = {
            sharePointFileEndpoint: "https://fondodbikini.sharepoint.com/_api/web/GetFolderByServerRelativeUrl('Documentos%20compartidos')?$select=Author/Title,ModifiedBy/Title&$expand=Author/Title,ModifiedBy/Title,Folders,Files"
        }

        //the defined scopes were updated for making calls to the SharePoint API.

        var requestObj = {
            scopes: ["https://fondodbikini.sharepoint.com/.default"]
        };

        var myMSALObj = new Msal.UserAgentApplication(msalConfig);
        // Register Callbacks for redirect flow
        myMSALObj.handleRedirectCallback(authRedirectCallBack);


        function signIn() {

            myMSALObj.loginPopup(requestObj).then(function(loginResponse) {
                //Login Success
                showWelcomeMessage();
                acquireTokenPopupAndCallAPI();

            }).catch(function(error) {
                console.log(error);
            });
        }


        function acquireTokenPopupAndCallAPI() {
            //Always start with acquireTokenSilent to obtain a token in the signed in user from cache
            myMSALObj.acquireTokenSilent(requestObj).then(function(tokenResponse) {

                //Http Request

                callAPI(sharePointConfig.sharePointFileEndpoint, tokenResponse.accessToken, graphAPICallback);

            }).catch(function(error) {
                console.log(error);
                // Upon acquireTokenSilent failure (due to consent or interaction or login required ONLY)
                // Call acquireTokenPopup(popup window)
                if (requiresInteraction(error.errorCode)) {
                    myMSALObj.acquireTokenPopup(requestObj).then(function(tokenResponse) {

                        //Http Request

                        callAPI(sharePointConfig.sharePointFileEndpoint, tokenResponse.accessToken, graphAPICallback);

                    }).catch(function(error) {
                        console.log(error);
                    });
                }
            });
        }


        function graphAPICallback(data) {
            document.getElementById("json").innerHTML = JSON.stringify(data, null, 2);
        }


        function showWelcomeMessage() {
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML = 'Welcome ' + myMSALObj.getAccount().userName + "to Microsoft Graph API";
            var loginbutton = document.getElementById('SignIn');
            loginbutton.innerHTML = 'Sign Out';
            loginbutton.setAttribute('onclick', 'signOut();');
        }

        function authRedirectCallBack(error, response) {
            if (error) {
                console.log(error);
            } else {
                if (response.tokenType === "access_token") {

                    callAPI(sharePointConfig.sharePointFileEndpoint, tokenResponse.accessToken, graphAPICallback);
                } else {
                    console.log("token type is:" + response.tokenType);
                }
            }
        }

        function requiresInteraction(errorCode) {
            if (!errorCode || !errorCode.length) {
                return false;
            }
            return errorCode === "consent_required" ||
                errorCode === "interaction_required" ||
                errorCode === "login_required";
        }

        // Browser check variables
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf('MSIE ');
        var msie11 = ua.indexOf('Trident/');
        var msedge = ua.indexOf('Edge/');
        var isIE = msie > 0 || msie11 > 0;
        var isEdge = msedge > 0;
        //If you support IE, our recommendation is that you sign-in using Redirect APIs
        //If you as a developer are testing using Edge InPrivate mode, please add "isEdge" to the if check
        // can change this to default an experience outside browser use
        var loginType = isIE ? "REDIRECT" : "POPUP";

        if (loginType === 'POPUP') {
            if (myMSALObj.getAccount()) { // avoid duplicate code execution on page load in case of iframe and popup window.
                showWelcomeMessage();
                acquireTokenPopupAndCallAPI();
            }
        } else if (loginType === 'REDIRECT') {
            document.getElementById("SignIn").onclick = function() {
                myMSALObj.loginRedirect(requestObj);
            };
            if (myMSALObj.getAccount() && !myMSALObj.isCallback(window.location.hash)) { // avoid duplicate code execution on page load in case of iframe and popup window.
                showWelcomeMessage();
                acquireTokenPopupAndCallAPI();
            }
        } else {
            console.error('Please set a valid login type');
        }


        function callAPI(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();

            /*
            xmlHttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }
*/
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);

            xmlHttp.send();
        }

        function callAPINew(theUrl, accessToken) {
            var xmlHttp = new XMLHttpRequest();



            xmlHttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    pintaResultadosCallback(JSON.parse(this.responseText));
                };
            }

            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xmlHttp.setRequestHeader('Accept', 'application/json; odata=verbose');
            xmlHttp.setRequestHeader('Content-Type', 'application/json');
            xmlHttp.send();
        }

        function signOut() {
            myMSALObj.logout();
        }

        function DameFicherosSharepoint() {
            //Always start with acquireTokenSilent to obtain a token in the signed in user from cache
            var miUrl = "https://fondodbikini.sharepoint.com/_api/web/GetFolderByServerRelativeUrl('Documentos%20compartidos')?$select=Author/Title,ModifiedBy/Title&$expand=Author/Title,ModifiedBy/Title,Folders,Files";

            myMSALObj.acquireTokenSilent(requestObj).then(function(tokenResponse) {

                //Http Request

                callAPINew(miUrl, tokenResponse.accessToken);

            }).catch(function(error) {
                console.log(error);
                // Upon acquireTokenSilent failure (due to consent or interaction or login required ONLY)
                // Call acquireTokenPopup(popup window)
                if (requiresInteraction(error.errorCode)) {
                    myMSALObj.acquireTokenPopup(requestObj).then(function(tokenResponse) {

                        //Http Request

                        callAPINew(miUrl, tokenResponse.accessToken);

                    }).catch(function(error) {
                        console.log(error);
                    });
                }
            });
        }

        function pintaResultadosCallback(data) {


            document.getElementById("misFicheros").innerHTML = "";

            document.getElementById("misFicheros").innerHTML += "<p>Mis Ficheros</p>"

            document.getElementById("misFicheros").innerHTML += "<div class='divTable'>";
            document.getElementById("misFicheros").innerHTML += "<div class='divTableRow'><div class='divTableCell'>Nombre</div><div class='divTableCell'>Autor</div><div class='divTableCell'>Creado</div><div class='divTableCell'>Editar</div></div>";




            var numeroFilaFichero = 0;
            var idFilaIframe = "";
            data.d.Files.results.forEach(function(file) {

                var sourceDoc = "%7B" + file.UniqueId.toUpperCase() + "%7D";
                var nombreFicheroEncode = encodeURI(file.Name);


                numeroFilaFichero++;
                idFilaIframe = "filaIframe" + numeroFilaFichero;

                botonEditarHtml = "<button onclick=\"EditarWord('" + idFilaIframe + "')\">Editar Documento</button>";
                miEnlace = "https://fondodbikini.sharepoint.com/:w:/r/_layouts/15/WopiFrame.aspx?sourcedoc=" + sourceDoc + "&file=" + nombreFicheroEncode + "&action=default&mobileredirect=true";
                document.getElementById("misFicheros").innerHTML += "<div class='divTableRow'><div class='divTableCell'>" + file.Name + "</div><div class='divTableCell'>" + file.Author.Title + "</div><div class='divTableCell'>" + file.TimeCreated + "</div><div class='divTableCell'>" + botonEditarHtml + "</div></div>";

                document.getElementById("misFicheros").innerHTML += "<div class='divTableRow' id='" + idFilaIframe + "' style='display:none'><iframe class='ventanaIframe' src='" + miEnlace + "'></div>"

            });

            document.getElementById("misFicheros").innerHTML += "</div>";
            document.getElementById("misFicheros").innerHTML += "<p>Mis Carpetas</p>"
            data.d.Folders.results.forEach(function(folder) {
                document.getElementById("misFicheros").innerHTML += '<div id="items">' + folder.Name + '</div>';

            });

        }

        function EditarWord(idIframe) {
            document.getElementById(idIframe).style.display = "block";
        }
    </script>
</body>

</html>